<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GUS STORE // OFICIAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        body { background: #050505; color: white; font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; }
        .hero-gradient { background: linear-gradient(to right, #3b82f6, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* HEADER RESPONSIVO */
        .main-header { padding: 20px 5%; display: flex; align-items: center; justify-content: flex-start; gap: 12px; }
        .profile-pic { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #3b82f6; overflow: hidden; background: #111; flex-shrink: 0; }
        @media (min-width: 768px) { .profile-pic { width: 80px; height: 80px; border-width: 3px; } }
        .profile-pic img { width: 100%; height: 100%; object-fit: cover; }

        /* GIGA-T√çTULO FLUIDO */
        .hero-section { text-align: center; padding: 10px 5% 40px; }
        .hero-title { 
            font-size: 13vw; /* Ajuste autom√°tico seg√∫n el ancho */
            line-height: 0.85; font-weight: 900; font-style: italic; text-transform: uppercase; 
            margin-bottom: 30px; letter-spacing: -2px; 
        }
        @media (min-width: 768px) { .hero-title { font-size: 9rem; letter-spacing: -5px; } }
        @media (min-width: 1200px) { .hero-title { font-size: 11rem; } }

        /* BUSCADOR */
        .search-gus { background: #0d0d0d; border: 2px solid #1a1a1a; border-radius: 20px; padding: 18px; width: 100%; max-width: 800px; color: white; outline: none; font-weight: 800; font-size: 16px; text-align: center; display: block; margin: 0 auto 30px; transition: 0.3s; }
        .search-gus:focus { border-color: #3b82f6; background: #111; }

        /* CATEGOR√çAS SCROLLABLE (CELULAR) */
        #pills-box { display: flex; gap: 10px; overflow-x: auto; padding: 5px 5%; scrollbar-width: none; -ms-overflow-style: none; justify-content: flex-start; }
        #pills-box::-webkit-scrollbar { display: none; }
        @media (min-width: 768px) { #pills-box { justify-content: center; } }

        .cat-pill { background: #111; border: 2px solid #222; padding: 12px 25px; border-radius: 100px; cursor: pointer; color: #555; font-weight: 900; font-size: 14px; text-transform: uppercase; white-space: nowrap; transition: 0.3s; }
        .cat-pill.active { border-color: #3b82f6; color: white; background: #3b82f6; }

        /* PLATAFORMAS (CUADRADOS) */
        #grid-marcas { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; padding: 20px 5% 40px; }
        .marca-item { background: #0d0e14; width: 85px; height: 85px; border-radius: 20px; border: 1px solid #1a1b26; cursor: pointer; transition: 0.3s; overflow: hidden; flex-shrink: 0; }
        @media (min-width: 768px) { .marca-item { width: 100px; height: 100px; border-radius: 25px; } }
        .marca-item:hover, .marca-item.active { border-color: #3b82f6; transform: scale(1.05); }
        .marca-item img { width: 100%; height: 100%; object-fit: cover; }

        /* GRID DE PRODUCTOS DIN√ÅMICO */
        #grid-productos { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; padding: 0 5% 60px; max-width: 1400px; margin: 0 auto;
            justify-items: center;
        }

        /* TARJETA */
        .card-producto { background: #0d0e14; width: 100%; max-width: 320px; border-radius: 40px; padding: 12px; border: 1px solid #1a1b26; cursor: pointer; position: relative; transition: 0.3s; }
        .card-producto:hover { transform: translateY(-5px); border-color: #3b82f6; }
        .card-img-wrap { width: 100%; aspect-ratio: 1/1; border-radius: 30px; background: #000; overflow: hidden; position: relative; }
        .card-img-wrap img { width: 100%; height: 100%; object-fit: cover; }
        
        .badge-renovable { position: absolute; top: 15px; right: 15px; background: #ff3b30; color: white; padding: 6px 14px; border-radius: 20px; font-weight: 900; font-size: 11px; text-transform: uppercase; }
        .badge-stock { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); background: #f2f2f2; color: black; padding: 6px 18px; border-radius: 20px; font-weight: 900; font-size: 12px; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); width: max-content; }

        .store-name { color: #00ff88; font-weight: 900; font-size: 16px; text-transform: lowercase; }
        .product-title { font-weight: 900; font-size: 20px; color: white; margin: 10px 0; text-transform: uppercase; font-style: italic; line-height: 1.1; }
        .price-pill { background: white; color: black; padding: 8px 22px; border-radius: 30px; font-weight: 900; font-size: 17px; display: inline-flex; align-items: center; gap: 6px; }

        /* MODALES BLUR */
        .modal-blur { 
            display: none; position: fixed; inset: 0; 
            background: rgba(0,0,0,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); 
            z-index: 10000; align-items: center; justify-content: center; padding: 20px; 
        }
        .ads-content { position: relative; max-width: 400px; width: 100%; }
        .ads-img { width: 100%; border-radius: 40px; border: 2px solid #333; }
        .ads-close { position: absolute; top: -15px; right: -15px; background: #ff3b30; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid #050505; }

        /* PANEL ADMIN RESPONSIVO */
        #admin-panel { display: none; position: fixed; inset: 0; background: #000; z-index: 15000; overflow-y: auto; }
        .admin-sidebar { width: 100%; padding: 20px; border-bottom: 1px solid #1a1a1a; }
        @media (min-width: 1024px) { 
            #admin-panel { display: none; flex-direction: row; }
            .admin-sidebar { width: 300px; height: 100vh; border-bottom: none; border-right: 1px solid #1a1a1a; }
        }

        .no-stock-full { grid-column: 1 / -1; width: 100%; text-align: center; padding: 60px 20px; color: #555; font-weight: 900; font-size: 18px; border: 2px dashed #1a1a1a; border-radius: 30px; }
    </style>
</head>
<body>

    <div id="ads-modal" class="modal-blur">
        <div class="ads-content">
            <div class="ads-close" onclick="closeAds()"><i class="fas fa-times"></i></div>
            <img id="ads-img-view" src="" class="ads-img">
        </div>
    </div>

    <div id="product-modal" class="modal-blur" onclick="closeProductModal()">
        <div class="bg-[#0d0d0d] w-full max-w-lg rounded-[45px] p-8 border border-zinc-800 text-center relative" onclick="event.stopPropagation()">
            <button onclick="closeProductModal()" class="absolute top-6 right-6 text-zinc-500 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <div class="w-full aspect-video rounded-[30px] overflow-hidden mb-6 bg-black"><img id="m-img" src="" class="w-full h-full object-cover"></div>
            <h2 id="m-title" class="text-2xl font-black italic uppercase mb-2"></h2>
            <div id="m-price" class="text-blue-500 font-black text-3xl mb-4"></div>
            <div id="m-desc" class="text-zinc-500 text-base mb-6 text-left bg-zinc-900/40 p-5 rounded-2xl border border-zinc-800 whitespace-pre-wrap max-h-40 overflow-y-auto"></div>
            <a id="m-ws-link" href="" target="_blank" class="bg-[#25d366] text-white p-4 rounded-2xl font-black uppercase text-lg block shadow-lg shadow-green-900/20">Pedir por WhatsApp</a>
        </div>
    </div>

    <div id="login-screen" class="modal-blur" style="display: none;">
        <div class="bg-[#0d0d0d] p-8 rounded-[40px] border border-zinc-800 w-full max-w-xs text-center">
            <h2 class="text-2xl font-black text-blue-500 mb-6 italic uppercase">GUS ADMIN</h2>
            <input type="text" id="user-in" class="w-full p-4 bg-black rounded-xl border border-zinc-800 mb-4 text-white" placeholder="Usuario">
            <input type="password" id="pass-in" class="w-full p-4 bg-black rounded-xl border border-zinc-800 mb-6 text-white" placeholder="Contrase√±a">
            <button onclick="login()" class="w-full bg-blue-600 p-4 rounded-xl font-black uppercase text-white">Ingresar</button>
        </div>
    </div>

    <div id="public-view">
        <header class="main-header">
            <div class="profile-pic"><img src="https://files.catbox.moe/nao1lj.jpg"></div>
            <div class="text-2xl md:text-3xl font-black italic uppercase tracking-tighter text-white">GUS <span class="text-blue-500">STORE</span></div>
        </header>

        <section class="hero-section">
            <h1 class="hero-title">ENTRETENIMIENTO<br><span class="hero-gradient">SIN L√çMITES</span></h1>
            <input type="text" id="gus-search" class="search-gus" placeholder="¬øQu√© buscas hoy?" onkeyup="searchFilter()">
            <div id="pills-box" class="no-scrollbar"></div>
            <div id="grid-marcas"></div>
        </section>

        <div id="grid-productos"></div>
    </div>

    <div id="admin-panel">
        <div class="admin-sidebar flex flex-row lg:flex-col overflow-x-auto lg:overflow-y-auto gap-2 lg:gap-4 no-scrollbar">
            <button onclick="switchTab('tab-prod')" class="flex-shrink-0 lg:w-full text-left p-4 bg-zinc-900 rounded-xl font-bold uppercase text-[10px]">üì¶ Tarjetas</button>
            <button onclick="switchTab('tab-plat')" class="flex-shrink-0 lg:w-full text-left p-4 bg-zinc-900 rounded-xl font-bold uppercase text-[10px]">üñºÔ∏è Plataformas</button>
            <button onclick="switchTab('tab-cat')" class="flex-shrink-0 lg:w-full text-left p-4 bg-zinc-900 rounded-xl font-bold uppercase text-[10px]">üìÇ Categor√≠as</button>
            <button onclick="switchTab('tab-ads')" class="flex-shrink-0 lg:w-full text-left p-4 bg-zinc-900 rounded-xl font-bold uppercase text-[10px]">üì¢ Anuncios</button>
            <button onclick="logout()" class="flex-shrink-0 lg:w-full text-left p-4 text-red-500 font-bold uppercase text-[10px]">Salir</button>
        </div>
        <main class="flex-1 p-6 lg:p-10 h-full overflow-y-auto bg-[#050505]">
             <div id="tab-prod" class="admin-sec active">
                <div class="bg-[#0d0d0d] p-6 lg:p-10 rounded-[40px] border border-zinc-800 max-w-2xl mb-10">
                    <h2 id="form-title-prod" class="text-xl font-black mb-6 uppercase italic text-blue-500">Gestionar Tarjeta</h2>
                    <div class="bg-zinc-900 p-6 rounded-2xl text-center cursor-pointer mb-5 border border-zinc-800" onclick="triggerFile('file-prod','prod')"><p id="p-label" class="text-zinc-500 uppercase text-[10px]">Subir Imagen</p></div>
                    <input type="file" id="file-prod" class="hidden" onchange="startCropping(this)">
                    <input type="text" id="p-name" class="w-full p-3 bg-black rounded-xl border border-zinc-800 mb-3 text-white" placeholder="Nombre">
                    <input type="number" id="p-price" class="w-full p-3 bg-black rounded-xl border border-zinc-800 mb-3 text-white" placeholder="Precio S/">
                    <input type="number" id="p-stock" class="w-full p-3 bg-black rounded-xl border border-zinc-800 mb-3 text-white" placeholder="Stock">
                    <input type="text" id="p-badge" class="w-full p-3 bg-black rounded-xl border border-zinc-800 mb-3 text-white" placeholder="Badge (Ej: Renovable)">
                    <textarea id="p-desc-admin" class="w-full p-3 bg-black rounded-xl border border-zinc-800 mb-6 text-white h-24" placeholder="Descripci√≥n..."></textarea>
                    <select id="p-cat-select" class="w-full p-3 bg-zinc-900 rounded-xl border border-zinc-800 mb-3 text-white" onchange="filterPlatByCat(this.value)"></select>
                    <select id="p-plat-select" class="w-full p-3 bg-zinc-900 rounded-xl border border-zinc-800 mb-6 text-white"></select>
                    <button id="btn-save-prod" onclick="saveProduct()" class="bg-blue-600 w-full p-4 rounded-xl font-black uppercase text-white">Publicar</button>
                </div>
                <div id="admin-list-prod" class="grid gap-2"></div>
             </div>

             <div id="tab-plat" class="admin-sec">
                <div class="bg-[#0d0d0d] p-6 rounded-[30px] border border-zinc-800 max-w-lg mb-10">
                    <h2 id="form-title-plat" class="text-xl font-black mb-6 uppercase italic text-blue-500">Plataforma</h2>
                    <div id="plat-upload-box" class="bg-zinc-900 rounded-2xl text-center cursor-pointer mb-5 border border-zinc-800 h-32 flex items-center justify-center" onclick="triggerFile('file-plat','plat')"><p class="text-zinc-500 text-[10px]">Logo</p></div>
                    <input type="file" id="file-plat" class="hidden" onchange="startCropping(this)">
                    <input type="text" id="plat-n" class="w-full p-3 bg-black rounded-xl border border-zinc-800 mb-3 text-white" placeholder="Nombre">
                    <select id="plat-cat-select" class="w-full p-3 bg-zinc-900 rounded-xl border border-zinc-800 mb-6 text-white"></select>
                    <button id="btn-save-plat" onclick="addPlat()" class="bg-blue-600 w-full p-4 rounded-xl font-black uppercase text-white">Guardar</button>
                </div>
                <div id="admin-list-plat" class="grid gap-2"></div>
             </div>

             <div id="tab-cat" class="admin-sec">
                <div class="bg-[#0d0d0d] p-6 rounded-[30px] border border-zinc-800 max-w-lg mb-10">
                    <h2 id="form-title-cat" class="text-xl font-black mb-4 uppercase italic text-blue-500">Categor√≠as</h2>
                    <input type="text" id="new-cat" class="w-full p-3 bg-black rounded-xl border border-zinc-800 mb-4 text-white" placeholder="Nombre">
                    <button id="btn-save-cat" onclick="addCat()" class="bg-blue-600 w-full p-4 rounded-xl font-black uppercase text-white">A√±adir</button>
                </div>
                <div id="admin-list-cat" class="grid gap-2"></div>
             </div>

             <div id="tab-ads" class="admin-sec">
                <div class="bg-[#0d0d0d] p-6 rounded-[30px] border border-zinc-800 max-w-lg mb-10 text-center">
                    <h2 class="text-xl font-black mb-6 uppercase italic text-blue-500">Anuncio</h2>
                    <div id="ads-upload-box" class="bg-zinc-900 rounded-2xl text-center cursor-pointer mb-5 border border-zinc-800 h-48 flex items-center justify-center overflow-hidden" onclick="triggerFile('file-ads','ads')"><p class="text-zinc-500">Imagen</p></div>
                    <input type="file" id="file-ads" class="hidden" onchange="startCropping(this)">
                    <button onclick="saveAd()" class="bg-blue-600 w-full p-4 rounded-xl font-black uppercase text-white mb-4">Publicar</button>
                    <button onclick="deleteAd()" class="bg-red-600 w-full p-4 rounded-xl font-black uppercase text-white">Eliminar</button>
                </div>
             </div>
        </main>
    </div>

    <div id="cropper-modal" class="modal-blur">
        <div class="bg-zinc-900 rounded-[40px] p-6 w-full max-w-md text-white text-center">
            <div class="h-64 bg-black rounded-2xl overflow-hidden mb-6"><img id="img-to-crop" style="max-width:100%;"></div>
            <div class="flex gap-3">
                <button onclick="cancelCrop()" class="flex-1 p-4 bg-zinc-800 rounded-2xl font-black uppercase text-sm">Salir</button>
                <button onclick="doneCrop()" class="flex-1 p-4 bg-blue-600 rounded-2xl font-black uppercase text-sm">Listo</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJjWRAi_GUdDOiBeRvtNLUJUUpEG7CSFU",
            authDomain: "gusstore-82d47.firebaseapp.com",
            projectId: "gusstore-82d47",
            storageBucket: "gusstore-82d47.firebasestorage.app",
            messagingSenderId: "882557761892",
            appId: "1:882557761892:web:e6f92f2c5cd6f63ba52271"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colProd = collection(db, "productos"), colCat = collection(db, "categorias"), colPlat = collection(db, "plataformas"), colAds = collection(db, "anuncios");

        let activeCat = "", activePlatId = "", cropper, finalBase64 = "", upType = "";
        let editIdProd = null, editIdPlat = null, editIdCat = null;
        const defaultLogo = "https://files.catbox.moe/nao1lj.jpg";
        window.allPlats = [], window.allProds = [], window.allCats = [];

        window.removeItem = async (c, id) => { if(confirm("¬øBorrar?")) await deleteDoc(doc(db, c, id)); };
        window.login = () => { if(document.getElementById('user-in').value === 'adminGus' && document.getElementById('pass-in').value === 'GusStore2026') { localStorage.setItem('gus_auth', 'true'); window.location.hash = '#admin/panel'; } else alert("Error"); };
        window.logout = () => { localStorage.removeItem('gus_auth'); window.location.hash = ''; location.reload(); };

        // SYNC CATEGORIAS
        onSnapshot(colCat, snap => {
            window.allCats = snap.docs.map(d => ({id: d.id, ...d.data()}));
            document.getElementById('pills-box').innerHTML = window.allCats.map(c => `<div class="cat-pill ${c.name===activeCat?'active':''}" onclick="window.setCat('${c.name}')">${c.name}</div>`).join('');
            const opts = '<option value="">Categor√≠a...</option>' + window.allCats.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            document.getElementById('p-cat-select').innerHTML = opts;
            document.getElementById('plat-cat-select').innerHTML = opts;
            document.getElementById('admin-list-cat').innerHTML = window.allCats.map(c => `
                <div class="flex justify-between items-center bg-zinc-900 p-4 rounded-xl mb-2"><span>${c.name}</span><div class="flex gap-3"><button onclick="prepareEditCat('${c.id}')" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="removeItem('categorias','${c.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div></div>`).join('');
            if(!activeCat && window.allCats.length > 0) window.setCat(window.allCats[0].name);
        });

        window.prepareEditCat = (id) => {
            const c = window.allCats.find(x => x.id === id);
            editIdCat = id; document.getElementById('new-cat').value = c.name;
            document.getElementById('form-title-cat').innerText = "Editando Categor√≠a";
            window.scrollTo(0,0);
        };

        window.addCat = async () => {
            const v = document.getElementById('new-cat').value.toUpperCase();
            if(editIdCat) await updateDoc(doc(db,'categorias',editIdCat), { name: v });
            else await addDoc(colCat, { name: v });
            location.reload();
        };

        // SYNC PLATAFORMAS
        onSnapshot(colPlat, snap => { 
            window.allPlats = snap.docs.map(d => ({id: d.id, ...d.data()})); 
            renderPlats();
            document.getElementById('admin-list-plat').innerHTML = window.allPlats.map(p => `
                <div class="flex justify-between items-center bg-zinc-900 p-4 rounded-xl mb-2"><span>${p.name}</span><div class="flex gap-3"><button onclick="prepareEditPlat('${p.id}')" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="removeItem('plataformas','${p.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div></div>`).join('');
        });

        window.prepareEditPlat = (id) => {
            const p = window.allPlats.find(x => x.id === id);
            editIdPlat = id; document.getElementById('plat-n').value = p.name;
            document.getElementById('plat-cat-select').value = p.cat;
            if(p.logo) document.getElementById('plat-upload-box').innerHTML = `<img src="${p.logo}" class="w-full h-full object-cover">`;
            document.getElementById('form-title-plat').innerText = "Editando Plataforma";
            window.scrollTo(0,0);
        };

        window.addPlat = async () => {
            const dta = { name: document.getElementById('plat-n').value, cat: document.getElementById('plat-cat-select').value };
            if(finalBase64) dta.logo = finalBase64;
            if(editIdPlat) await updateDoc(doc(db,'plataformas',editIdPlat), dta);
            else await addDoc(colPlat, dta);
            location.reload();
        };

        // SYNC PRODUCTOS
        onSnapshot(colProd, snap => { 
            window.allProds = snap.docs.map(d => ({id: d.id, ...d.data()})); 
            renderGrid();
            document.getElementById('admin-list-prod').innerHTML = window.allProds.map(p => `
                <div class="flex justify-between items-center bg-zinc-900 p-4 rounded-xl mb-2"><span>${p.nombre}</span><div class="flex gap-3"><button onclick="prepareEditProd('${p.id}')" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="removeItem('productos','${p.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div></div>`).join('');
        });

        window.prepareEditProd = (id) => {
            const p = window.allProds.find(x => x.id === id);
            editIdProd = id; document.getElementById('p-name').value = p.nombre;
            document.getElementById('p-price').value = p.precio;
            document.getElementById('p-stock').value = p.stock;
            document.getElementById('p-badge').value = p.renovable || "";
            document.getElementById('p-desc-admin').value = p.desc || "";
            document.getElementById('p-cat-select').value = p.cat;
            window.filterPlatByCat(p.cat);
            setTimeout(() => { document.getElementById('p-plat-select').value = p.platId; }, 100);
            document.getElementById('form-title-prod').innerText = "Editando Tarjeta";
            window.scrollTo(0,0);
        };

        window.saveProduct = async () => {
            const dta = { nombre: document.getElementById('p-name').value, precio: document.getElementById('p-price').value, stock: document.getElementById('p-stock').value, renovable: document.getElementById('p-badge').value, desc: document.getElementById('p-desc-admin').value, cat: document.getElementById('p-cat-select').value, platId: document.getElementById('p-plat-select').value };
            if(finalBase64) dta.img = finalBase64;
            if(editIdProd) await updateDoc(doc(db,'productos',editIdProd), dta);
            else await addDoc(colProd, dta);
            location.reload();
        };

        // ANUNCIOS L√ìGICA
        onSnapshot(colAds, snap => {
            const ads = snap.docs.map(d => d.data());
            if (ads.length > 0 && !window.location.hash.includes('admin')) {
                document.getElementById('ads-img-view').src = ads[0].img;
                document.getElementById('ads-modal').style.display = 'flex';
            }
        });
        window.saveAd = async () => { if(!finalBase64) return; await setDoc(doc(db, "anuncios", "actual"), { img: finalBase64 }); location.reload(); };
        window.deleteAd = async () => { await deleteDoc(doc(db, "anuncios", "actual")); location.reload(); };
        window.closeAds = () => document.getElementById('ads-modal').style.display = 'none';

        // NAVEGACI√ìN
        window.setCat = (c) => { activeCat = c; activePlatId = ""; renderPlats(); renderGrid(); };
        window.setPlat = (id) => { activePlatId = id; renderPlats(); renderGrid(); };

        function renderPlats() {
            const box = document.getElementById('grid-marcas');
            if (activeCat.toUpperCase() !== 'STREAMING') { box.innerHTML = ""; return; }
            box.innerHTML = window.allPlats.filter(p => p.cat === activeCat).map(p => `<div class="marca-item ${p.id===activePlatId?'active':''}" onclick="window.setPlat('${p.id}')"><img src="${p.logo||defaultLogo}"></div>`).join('');
        }

        function renderGrid() {
            const grid = document.getElementById('grid-productos'); grid.innerHTML = ""; 
            let prds = [];
            if (activeCat.toUpperCase() === 'STREAMING') {
                if(!activePlatId) { grid.innerHTML = `<div class="no-stock-full">ELIGE UNA PLATAFORMA</div>`; return; }
                prds = window.allProds.filter(p => p.platId === activePlatId && p.cat === activeCat);
            } else {
                prds = window.allProds.filter(p => p.cat === activeCat);
            }

            if(prds.length === 0 && activeCat) grid.innerHTML = `<div class="no-stock-full">SIN STOCK POR AHORA</div>`;
            
            prds.forEach(p => {
                const card = document.createElement('div'); card.className = 'card-producto';
                card.onclick = () => openModal(p);
                card.innerHTML = `
                    <div class="card-img-wrap">
                        <img src="${p.img || defaultLogo}">
                        <div class="badge-renovable">${p.renovable || 'Renovable'}</div>
                        <div class="badge-stock"><i class="fas fa-eye"></i> ${p.stock || 0} Stock</div>
                    </div>
                    <div class="card-footer px-2">
                        <div class="flex items-center gap-2 mt-4">
                            <div class="w-8 h-8 rounded-full border border-zinc-800 overflow-hidden bg-zinc-900"><img src="https://files.catbox.moe/nao1lj.jpg" class="w-full h-full object-cover"></div>
                            <span class="store-name">Gus Store</span><i class="fas fa-check-circle text-blue-500 text-[9px]"></i>
                        </div>
                        <div class="product-title">‚≠ê ${p.nombre} ‚ú¶</div>
                        <div class="price-pill">üëâ s/ ${p.precio}</div>
                    </div>`;
                grid.appendChild(card);
            });
        }

        window.openModal = (p) => {
            document.getElementById('m-img').src = p.img || defaultLogo;
            document.getElementById('m-title').innerText = p.nombre;
            document.getElementById('m-price').innerText = "S/ " + p.precio;
            document.getElementById('m-desc').innerText = p.desc || "...";
            const msg = encodeURIComponent(`Hola Gus, vengo de tu web Gus Store. Quiero comprar ${p.nombre} de S/ ${p.precio}. ¬øA d√≥nde te Yapeo?`);
            document.getElementById('m-ws-link').href = `https://wa.me/519288632832?text=${msg}`;
            document.getElementById('product-modal').style.display = 'flex';
        };
        window.closeProductModal = () => document.getElementById('product-modal').style.display = 'none';

        // HELPERS
        window.filterPlatByCat = (c) => { document.getElementById('p-plat-select').innerHTML = window.allPlats.filter(p => p.cat === c).map(p => `<option value="${p.id}">${p.name}</option>`).join(''); };
        window.triggerFile = (id, type) => { upType = type; document.getElementById(id).click(); };
        window.startCropping = (input) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('cropper-modal').style.display = 'flex';
                const img = document.getElementById('img-to-crop'); img.src = e.target.result;
                if(cropper) cropper.destroy();
                cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 });
            };
            reader.readAsDataURL(input.files[0]);
        };
        window.doneCrop = () => { 
            finalBase64 = cropper.getCroppedCanvas().toDataURL('image/jpeg', 0.8); 
            document.getElementById('cropper-modal').style.display = 'none'; 
            if(upType === 'plat') document.getElementById('plat-upload-box').innerHTML = `<img src="${finalBase64}" class="w-full h-full object-cover">`; 
            else if(upType === 'ads') document.getElementById('ads-upload-box').innerHTML = `<img src="${finalBase64}" class="w-full h-full object-cover">`; 
            else document.getElementById('p-label').innerText = "‚úì LISTO"; 
        };
        window.cancelCrop = () => document.getElementById('cropper-modal').style.display='none';
        window.switchTab = (id) => { document.querySelectorAll('.admin-sec').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); };
        window.searchFilter = () => {
            const v = document.getElementById('gus-search').value.toLowerCase();
            document.querySelectorAll('.card-producto').forEach(c => c.style.display = c.innerText.toLowerCase().includes(v) ? 'block' : 'none');
        };
        const checkAuth = () => {
            const h = window.location.hash;
            document.getElementById('login-screen').style.display = (h === '#admin/login') ? 'flex' : 'none';
            document.getElementById('admin-panel').style.display = (h === '#admin/panel' && localStorage.getItem('gus_auth')) ? 'flex' : 'none';
            document.getElementById('public-view').style.display = (h === '#admin/login' || h === '#admin/panel') ? 'none' : 'block';
        };
        window.onhashchange = checkAuth; checkAuth();
    </script>
</body>
</html>
